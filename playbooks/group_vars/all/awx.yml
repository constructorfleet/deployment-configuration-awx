---

awx_host_config_key: 9931bad6-6526-4bf7-81b0-d56e67df3e00

awx_secret_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          65343034663434373737323738323939386466366632623562323964346362346231643332643261
          6166623865383138626337623536613863376162323163620a623034356561646231306566393665
          38326338343732363335663537346239333065326136656233303461316437336666663965353863
          3665326263643838620a303837333930386366353934643765306464376539643364313263353630
          6432
awx_github_deploy_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63316432306163343739303164323965316163396439313433393931666432653061306261663134
          6334336565333965343664653434666239653865336662350a613765373336626466313539623666
          61303335313061666563303333363162646533653138393833386363363762336337643165333537
          6534653634356335300a346638333234316538626163643033326361663063366138326538653532
          66383237313637353236303637316334366166636564313335663931393833333565626661666536
          63653836326631373830396265373633356337616463396234623232323833613939303261373431
          66653662326537613265663038323339383231336533353430623462313265313566626136386233
          31643935643634376139343136363866613536666363636431376631343437323534366361366138
          35643339336635343235313634373639636362643665386531306530613036313463613233646334
          38373266663964346236333631356661303333656437633865633162653533383330366661623737
          33383364366361656630663734336166336261353139363735666332383039333763613464353535
          35303465663037623066643862626365373663323434666164326364336666636332636638386336
          34313535313534383063666133313432306135633037376663386638376362363039383233333363
          65646437393662323934386130373033343333646263636137663334643061303037363737306464
          33616232643433626133303636353461386566336138323961316434633737633838343933303064
          61373661303238373032336638653033623966663131316162306161393364623832313161343863
          35613062613836393934323633333238383234313232643966396434306132623765313736316435
          61353935376362363165353961633832393062313833383165343531633034353461373330303466
          36386538393362313438626538356532313430353161316631363462383735666164303237343032
          38356261363564373434393863623031316433393031326166353731636362636137623864653431
          31373362306361643235386635306364343136313432383133663961666335633630323232343330
          38633866393430393837636239303035613065623835663866343836343065646333626236363363
          62343465396266393333623263343062323564663962336163613966316131326138363666373936
          36343565646636633532633763643165313335663366376334323437613234313939303337323230
          35303465393965653265363564383437656632656665636638643035623133316339623131336666
          64313036636536643764653462633163643364623861393337376536653566376463393765646331
          33656534613963313231393566613065393764653362323334333631313161653530326638363066
          64623966353665343631323865653934393439363563636566653962383137663032623665326432
          37376361323330343536393739353464653962363931633638616432313961393730666466376266
          30366532363733613762663934613735653965356362626536633066306161336464306566303639
          36623433623035336530326134313739613561653263306164656465646332366638356461333539
          66326137306138623466616564636431316639646361386231343635306437376530353933373362
          39306130393862356534386237383933303561643264363264353463336363353261373261373239
          32356263613134663134313534323239636163633731336230323431636434653962626132343934
          36623239663632306433396237623065616536336364663933383438653130333632313662633663
          37346563386635653930356335373130353337653164623363666534303030343163306161363366
          63373432303365643564363663383634376235333766333732306134323432346339386338343232
          32353633613334643865316239396136303366623566616637306637626539626137313832616161
          30653730386330353835303539616138303536326638303136313966376461623466646665333036
          38666365323234393333303133343130313632626264313165343564353164666138663637303766
          66333030346162646531366532653635636661663038646639306534323762333934303532376163
          30626266393631663031613737613934336134386639333134616134376636386639326335383161
          65396138623630636439326330363563313861333465373938346663386566396237313531643239
          31306631363861353362396239333436386163326236316633383435376264653831663738633132
          31353632313130613964393738633739313231343932663031623061343565376464333133656164
          30396261643466326161363731333066363830316131313830326637636537666332363231343261
          32393166353639323130323132663730303065373837313135653337333561333435326164353532
          34376663323063393632343131376465306231643932633364396534623638653961323666386464
          62396464646633333932663239356535383230323235323461653633346336393838626162616631
          62323066633766636563383861376666316436353032623666316466346232316266303566616235
          33383837306432343665303236393930616562646230353731316136636638373463366262393862
          66323661326562373838383637343462636636393236633630366465613962613963386364336663
          65646365366639613761363139383836383835656636316635656239323430636262366165333762
          62646239363565633533623062363836663237623036343638373965373136373537396161303432
          31356136633232316662393766316439326236393663633361393235366364336539393030626637
          36336138646537613332353265333161376663393062373134313265633634333638386139373231
          61633565363031333632653037323437613235636437323833616462396563353836346632323665
          31373632663136353564316362636637306330623934353131643434616533633339333833656662
          30306536653034333736333166616336663864323461333364656261643362306134616262376539
          61383865363437396230613538306532333435363934373331306362353433653932343836353738
          34383739303861366134646465336334323135393634643261333535613936386163663363323334
          39393136633939356231303535373130313763346231323531313434626634623832323739343939
          31333135613161653638666330383734396436353433386161343365616632613462646436313736
          34366336366534633634613465393039393364623931306665396262333436396566666563363665
          66343430306635396334343561353263643532366139353631653638336338386138343663663965
          36613061623561646531383861366266393264343863303261376362643430343630636465613762
          33396331326262393561363635323330303538363130613531633437633436663766343537336631
          36386235316237313066613233656239353438326230663237393036303331396238396237363466
          34653361656263613031646230313137333336626638363130346339333132383237373932393539
          30623333653764656436626236373264373436356435316134623330653838336364303631376439
          30326336383465383938353130366436653231623465643063646132383634643163316238323533
          32643938356462343464306266333731306365303562663132353233366131383363353838616437
          64316166636466616437363039636265376464623966663864613935363862653634383030393864
          62306432623366323433386530383332373834636631396338643263626333633339326666623936
          30343830373038633965613537633463616136316533663164666337323139653438323438376533
          61636162336336623863303563396130613231336336393836386332613165323735356630663633
          61616436363732356235636632393035353562383461333765653531663937646635326138336436
          34386533626137313933366339323865613530663564633339383862626461353138323037346331
          61613735313136376465333963646465376436666231326161633964633331646238636532303363
          66393764386635393833623365356134383165343666653639393866616363333839346234336635
          32623066326364396234643931363338373665616535326138643438636632333836353862613661
          34373439303662356230616565386461343966653364376363623634653366376464383663386636
          31396265323430346138393131386332313266313236613263326461326433613663383635383430
          62646163323461666133323861303531356530613437356562393931323432373632633839396265
          37653539646538663833626464636333636236623864363061343465376137383862396264336532
          34613933306135663965393131653137626263633662613266353338613633353763653431373065
          35663466306531366466323631333066363338386563303263353637646164316331633134393236
          66636133363765313366
awx_pg_database: awx
awx_pg_port: 5432
awx_pg_username: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          33333633346464613338663565366138616635306566626530393662613338623239373030326664
          3135616264613232626236633365353339633333303061650a343064396362633633313061636463
          38356161643166356131636438386333336264663436323833376465636638376636353637313939
          3036316531353132300a326235346437353961626338663966376166363931386439663133363438
          3764
awx_pg_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          65623330366339313431383964643230633239323262653739333464343839333731353636653530
          6139326566613664313732316236323632653730353765390a383930643637353432633430633032
          61663965666339656434313563343130633461303830623730346335363238323033353736393838
          6162663535376564390a363363343064366461333863333033353238323336613438626138626265
          3538
awx_pg_admin_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          38383136313331613335623334313730313661306561663937336234643235643064336262653262
          6539396436613761396662303634366230623434656332340a643165393137643230653865386664
          34393430353239363237363863396136383537656164386131646535386662343461343731656161
          6632626430373831330a663831303963616164623730326634316533363135363366313465356166
          3635

awx_inventories:
  - name: DEV - PrettyBaked.com
    description: Hosts retrieved from Foreman
    organization: '{{ (organizations | first)["name"] }}'
    source:
      name: Foreman Hosts
      credential: Foreman
      kind: satellite6
      verbosity: 2
      update_on_launch: true
      variables:
        want_facts: true
        want_host_group: true
        want_hostcollections: false
        want_params: true
        group_prefix: ''


awx_job_templates:
  - name: Install/Upgrade Foreman Instance
    project: Provisioning and Deployment
    playbook: playbooks/foreman.yml
    credentials:
      - ansible-root
      - ansible-vault
  - name: Install/Upgrade AWX Instance
    project: Provisioning and Deployment
    playbook: playbooks/awx.yml
    credentials:
      - ansible-root
      - ansible-vault

awx_credentials:
  - name: ansible-root
    credential_type: Machine
    inputs:
      ssh_key_data: '{{ lookup("file", "id_rsa_foreman_proxy") }}'
  - name: ansible-github
    credential_type: Source Control
    inputs:
      ssh_key_data: '{{ awx_github_deploy_key }}'
  - name: ansible-vault
    credential_type: Vault
    inputs:
      vault_id: 'ansible-vault'
      vault_password: '{{ vault_password }}'
  - name: Foreman
    credential_type: Red Hat Satellite 6
    inputs:
      username: "{{ foreman.admin_username }}"
      password: "{{ foreman.admin_password }}"
      host: "{{ foreman.url }}"
  - name: Galaxy
    credential_type: Ansible Galaxy/Automation Hub API Token
    inputs:
      url: https://galaxy.ansible.com
      token: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          37383163633334643031336465636565646533363362336639626436616635383765343336363938
          6538396134356438656530303761343533626161353736610a313133333833323637363263663535
          63663939363165333138363065383064643665646565363761313331633639303437663732323131
          3236656137663662340a653966303331353730336432666634353365636266353937356536626633
          63306464343231663263646531333363356135633631343966613665353938356236316238663438
          3963646561356233623261386661323665663530623666643131

awx_projects:
  - name: Provisioning and Deployment
    description: Provision, Deploy and Configuration of Systems
    scm_type: git
    scm_credential: ansible-github
    scm_clean: true
    scm_branch: enhancement/symplify_foreman_awx
    scm_update_on_launch: true
    scm_url: git@github.com:constructorfleet/deployment-configuration-awx.git
    local_path: deployment-configuration-awx

awx_ldap_auth:
  - name: SESSION_COOKIE_AGE
    value: "28800"
  - name: AUTH_LDAP_SERVER_URI
    value: "ldap://{{ ldap_authentication.host }}:{{ ldap_authentication.server_port }}"
  - name: AUTH_LDAP_BIND_DN
    value: "{{ ldap_authentication.account_dn }}"
  - name: AUTH_LDAP_GROUP_TYPE
    value: PosixGroupType
  - name: AUTH_LDAP_USER_SEARCH
    value:
      - "{{ ldap_authentication.users_base }}"
      - SCOPE_SUBTREE
      - (uid=%(user)s)
  - name: AUTH_LDAP_GROUP_SEARCH
    value:
      - "{{ ldap_authentication.groups_base  }}"
      - SCOPE_SUBTREE
      - (objectClass=posixGroup)
  - name: AUTH_LDAP_USER_ATTR_MAP
    value:
      first_name: "{{ ldap_authentication.attr_firstname }}"
      last_name: "{{ ldap_authentication.attr_lastname }}"
      email: "{{ ldap_authentication.attr_mail }}"
  - name: AUTH_LDAP_GROUP_TYPE_PARAMS
    value:
      name_attr: cn
  - name: AUTH_LDAP_USER_FLAGS_BY_GROUP
    value:
      is_superuser:
        - "cn=admin,{{ ldap_authentication.groups_base }}"
  - name: AUTH_LDAP_BIND_PASSWORD
    value: "{{ ldap_authentication.account_password }}"
  - name: AUTH_LDAP_ORGANIZATION_MAP
    value: "{{ organizations | community.general.json_query('[*].{ org: name, groups: { admins: join(`,`, [join(``, [`cn=`, usergroups[?admin].ldap_cn | [0]]), `|groups_base|`]), users: join(`,`, [join(``, [`cn=`, usergroups[?!admin].ldap_cn | [0]]), `|groups_base|`])}}') | to_json | replace('|groups_base|', ldap_authentication.groups_base) | from_json | items2dict(key_name='org', value_name='groups') }}"

awx_compose_project:
  - project_name: awx
    pull: true

    definition:
      version: '3.5'
      x-logging: &default-logging
        driver: journald

      networks:
        awx:
          name: awx
          driver: bridge
          ipam:
            driver: default
            config:
              - subnet: 172.3.27.0/24

      services:
        redis:
          image: redis
          container_name: awx-redis
          hostname: awx-redis
          restart: unless-stopped
          networks:
            awx:
              aliases:
                - redis
                - awx_redis
          environment:
            http_proxy: "{{ http_proxy | default('') }}"
            https_proxy: "{{ https_proxy | default('') }}"
            no_proxy: "{{ no_proxy | default('') }}"
          command: ["/usr/local/etc/redis/redis.conf"]
          volumes:
            - "{{ awx_docker_compose_dir }}/redis.conf:/usr/local/etc/redis/redis.conf:ro"
            - "{{ awx_docker_compose_dir }}/redis_socket:/var/run/redis/:rw"
        postgres:
          container_name: awx-postgres
          image: postgres:10
          hostname: awx-postgres
          networks:
            awx:
              aliases:
                - postgres
                - awx_postgres
          volumes:
            - "{{ awx_postgres_data_dir }}/10/data/:/var/lib/postgresql/data/pgdata:Z"
          environment:
            POSTGRES_USER: "{{ awx_pg_username }}"
            POSTGRES_PASSWORD: "{{ awx_pg_password }}"
            POSTGRES_DB: '{{ awx_pg_database }}'
            PGDATA: "/var/lib/postgresql/data/pgdata"
            http_proxy: "{{ http_proxy | default('') }}"
            https_proxy: "{{ https_proxy | default('') }}"
            no_proxy: "{{ no_proxy | default('') }}"
          logging:
            <<: *default-logging
            options:
              tag: awx-postgres

        web:
          container_name: awx-web
          image: "ansible/awx:16.0.0"
          depends_on:
            - redis
            - postgres
            - task
          ports:
            - "{{ awx.port }}:8052"
          networks:
            awx:
              aliases:
                - web
                - awxweb
                - awx_web
          hostname: awx-web
          user: root
          volumes:
            - "{{ awx_docker_compose_dir }}/SECRET_KEY:/etc/tower/SECRET_KEY"
            - "{{ awx_docker_compose_dir }}/environment.sh:/etc/tower/conf.d/environment.sh"
            - "{{ awx_docker_compose_dir }}/credentials.py:/etc/tower/conf.d/credentials.py"
            - "{{ awx_docker_compose_dir }}/nginx.conf:/etc/nginx/nginx.conf:ro"
            - "{{ awx_docker_compose_dir }}/redis_socket:/var/run/redis/:rw"
            - "{{ awx_project_data_dir }}:/var/lib/awx/projects:rw"
            - '/etc/localtime:/etc/localtime:ro'
          environment:
            http_proxy: "{{ http_proxy | default('') }}"
            https_proxy: "{{ https_proxy | default('') }}"
            no_proxy: "{{ no_proxy | default('') }}"
          logging:
            <<: *default-logging
            options:
              tag: awx-web

        task:
          container_name: awx-task
          image: "ansible/awx:16.0.0"
          depends_on:
            - redis
            - postgres
          networks:
            awx:
              aliases:
                - task
                - awxtask
                - awx_task
                - awx-task
          hostname: awx
          user: root
          command: /usr/bin/launch_awx_task.sh
          volumes:
            - "{{ awx_docker_compose_dir }}/SECRET_KEY:/etc/tower/SECRET_KEY"
            - "{{ awx_docker_compose_dir }}/environment.sh:/etc/tower/conf.d/environment.sh"
            - "{{ awx_docker_compose_dir }}/credentials.py:/etc/tower/conf.d/credentials.py"
            - "{{ awx_docker_compose_dir }}/nginx.conf:/etc/nginx/nginx.conf:ro"
            - "{{ awx_docker_compose_dir }}/redis_socket:/var/run/redis/:rw"
            - "{{ awx_project_data_dir }}:/var/lib/awx/projects:rw"
            - '/etc/localtime:/etc/localtime:ro'
          environment:
            http_proxy: "{{ http_proxy | default('') }}"
            https_proxy: "{{ https_proxy | default('') }}"
            no_proxy: "{{ no_proxy | default('') }}"
          logging:
            <<: *default-logging
            options:
              tag: awx-web