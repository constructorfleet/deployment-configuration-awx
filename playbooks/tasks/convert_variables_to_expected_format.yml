---

- name: Generate the AWX Compose Project
  ansible.builtin.set_fact:
    awx_compose_project:
      - project_name: awx
        pull: true

        definition:
          version: '3.5'
          x-logging: &default-logging
            driver: journald

          networks:
            awx:
              name: awx
              driver: bridge
              ipam:
                driver: default
                config:
                  - subnet: 172.3.27.0/24

          services:
            redis:
              image: redis
              container_name: awx-redis
              hostname: awx-redis
              restart: unless-stopped
              networks:
                awx:
                  aliases:
                    - redis
                    - awx_redis
              environment:
                http_proxy: "{{ http_proxy | default('') }}"
                https_proxy: "{{ https_proxy | default('') }}"
                no_proxy: "{{ no_proxy | default('') }}"
              command: ["/usr/local/etc/redis/redis.conf"]
              volumes:
                - "{{ awx_docker_compose_dir }}/redis.conf:/usr/local/etc/redis/redis.conf:ro"
                - "{{ awx_docker_compose_dir }}/redis_socket:/var/run/redis/:rw"
            postgres:
              container_name: awx-postgres
              image: postgres:10
              hostname: awx-postgres
              networks:
                awx:
                  aliases:
                    - postgres
                    - awx_postgres
              volumes:
                - "{{ awx_postgres_data_dir }}/10/data/:/var/lib/postgresql/data/pgdata:Z"
              environment:
                POSTGRES_USER: "{{ awx_pg_username }}"
                POSTGRES_PASSWORD: "{{ awx_pg_password }}"
                POSTGRES_DB: '{{ awx_pg_database }}'
                PGDATA: "/var/lib/postgresql/data/pgdata"
                http_proxy: "{{ http_proxy | default('') }}"
                https_proxy: "{{ https_proxy | default('') }}"
                no_proxy: "{{ no_proxy | default('') }}"
              logging:
                <<: *default-logging
                options:
                  tag: awx-postgres

            web:
              container_name: awx-web
              image: "ansible/awx:16.0.0"
              depends_on:
                - redis
                - postgres
                - task
              ports:
                - "{{ awx.port }}:8052"
              networks:
                awx:
                  aliases:
                    - web
                    - awxweb
                    - awx_web
              hostname: awx-web
              user: root
              volumes:
                - "{{ awx_docker_compose_dir }}/SECRET_KEY:/etc/tower/SECRET_KEY"
                - "{{ awx_docker_compose_dir }}/environment.sh:/etc/tower/conf.d/environment.sh"
                - "{{ awx_docker_compose_dir }}/credentials.py:/etc/tower/conf.d/credentials.py"
                - "{{ awx_docker_compose_dir }}/nginx.conf:/etc/nginx/nginx.conf:ro"
                - "{{ awx_docker_compose_dir }}/redis_socket:/var/run/redis/:rw"
                - "{{ awx_project_data_dir }}:/var/lib/awx/projects:rw"
                - '/etc/localtime:/etc/localtime:ro'
              environment:
                http_proxy: "{{ http_proxy | default('') }}"
                https_proxy: "{{ https_proxy | default('') }}"
                no_proxy: "{{ no_proxy | default('') }}"
              logging:
                <<: *default-logging
                options:
                  tag: awx-web

            task:
              container_name: awx-task
              image: "ansible/awx:16.0.0"
              depends_on:
                - redis
                - postgres
              networks:
                awx:
                  aliases:
                    - task
                    - awxtask
                    - awx_task
                    - awx-task
              hostname: awx
              user: root
              command: /usr/bin/launch_awx_task.sh
              volumes:
                - "{{ awx_docker_compose_dir }}/SECRET_KEY:/etc/tower/SECRET_KEY"
                - "{{ awx_docker_compose_dir }}/environment.sh:/etc/tower/conf.d/environment.sh"
                - "{{ awx_docker_compose_dir }}/credentials.py:/etc/tower/conf.d/credentials.py"
                - "{{ awx_docker_compose_dir }}/nginx.conf:/etc/nginx/nginx.conf:ro"
                - "{{ awx_docker_compose_dir }}/redis_socket:/var/run/redis/:rw"
                - "{{ awx_project_data_dir }}:/var/lib/awx/projects:rw"
                - '/etc/localtime:/etc/localtime:ro'
              environment:
                http_proxy: "{{ http_proxy | default('') }}"
                https_proxy: "{{ https_proxy | default('') }}"
                no_proxy: "{{ no_proxy | default('') }}"
              logging:
                <<: *default-logging
                options:
                  tag: awx-web

- name: Set system users for Foreman
  ansible.builtin.set_fact:
    foreman_system_users:
      - name: foreman
        uid: 998
        gid: 998
        home_dir: /usr/share/foreman
        directories:
          - name: .ssh
            mode: '0755'
            files:
              - source: id_rsa.foreman
                dest: id_rsa
                decrypt: true
                mode: '0600'
              - source: id_rsa.foreman.pub
                dest: id_rsa.pub
                decrypt: true
                mode: '0644'
      - name: foreman-proxy
        uid: 997
        gid: 997
        home_dir: /usr/share/foreman-proxy
        directories:
          - name: .ssh
            mode: '0755'
            files:
              - source: id_rsa_foreman_proxy
                dest: id_rsa_foreman_proxy
                decrypt: true
                mode: '0600'
              - source: id_rsa_foreman_proxy.pub
                dest: id_rsa_foreman_proxy.pub
                decrypt: true
                mode: '0644'
